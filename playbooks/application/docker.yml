#!/usr/bin/env ansible-playbook
---

- name: Config docker env
  hosts: application
  tasks:
   - name: Creates directory for docker
     file:
       path: '{{docker_files_path}}'
       state: directory
       recurse: yes

   - name: Ensure directory structure for docker
     file:
       path: '{{docker_files_path}}/{{item.path}}'
       state: directory
       mode: '{{item.mode}}'
       force: no
       recurse: yes
     with_filetree: templates/docker/
     when: item.state == 'directory'
     ignore_errors: yes
     no_log: true

   - name: Copy Docker files
     template:
       src: '{{item.src}}'
       dest: '{{docker_files_path}}/{{item.path}}'
       force: yes
       mode: '{{item.mode}}'
       group: '{{item.group}}'
       owner: '{{item.owner}}'
     with_filetree: templates/docker/
     when: item.state == 'file' and (item.src | basename) != '.gitignore'
     ignore_errors: yes
     no_log: true

   - name: Fix mongodb key permissions
     become: yes
     file:
       path: '{{docker_files_path}}/mongodb/config/keyfile'
       mode: '0400'
       owner: '999'
       group: '999'

   - name: Fix container folders permissions
     become: yes
     file:
       path: '{{item}}'
       owner: '999'
       group: '999'
     with_items:
      - '{{docker_files_path}}/mongodb/data/log'
      - '{{docker_files_path}}/mongodb/data/home'
      #- '{{docker_files_path}}/rabbitmq/data/log'
      #- '{{docker_files_path}}/rabbitmq/data/lib'
      #- '{{docker_files_path}}/nginx/runtime/logs'
      #- '{{docker_files_path}}/nginx/runtime/caches'
      #- '{{docker_files_path}}/mysql/data/db'
      #- '{{docker_files_path}}/mysql/data/log'
      #- '{{docker_files_path}}/elasticsearch/data'
      #- '{{docker_files_path}}/redis/data'

   - name: Fix config files permission
     file:
       path: '{{item}}'
       mode: 'u=rw,g=r,o=r' #0644
     with_items:
      - '{{docker_files_path}}/rabbitmq/config/enabled_plugins'
      - '{{docker_files_path}}/rabbitmq/config/rabbitmq.conf'

   - name: "Add alias for docker container"
     lineinfile:
       path: ~/.bashrc
       line: '{{item}}'
     with_items:
      - "alias php='{{docker_files_path}}/php-cli/cli.sh'"
      - "alias composer='{{docker_files_path}}/php-cli/composer.sh'"
      - "alias node='{{docker_files_path}}/node/node.sh'"
      - "alias mongo='{{docker_files_path}}/mongodb/mongodb.sh'"
      - "alias redis='{{docker_files_path}}/redis/redis.sh'"
      - "alias nginx='{{docker_files_path}}/nginx/nginx.sh'"
      - "alias mysql='{{docker_files_path}}/mysql/mysql.sh'"
      - "alias rabbitmq='{{docker_files_path}}/rabbitmq/rabbitmq.sh'"
      - "alias postgres='{{docker_files_path}}/postgres/postgres.sh'"
...